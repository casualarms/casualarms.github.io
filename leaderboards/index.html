<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Leaderboards – Casual ARMS</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/assets/style.css">
	<script src="/script/general.js"></script>
	<script src="/data/support.js"></script>
	<style>
	
	h3 { background-color: black; }
	
	#season-nav {
		text-align: center;
		display: none;
	}
	
	.tier {
		max-width: 330pt;
		margin: 0 auto;
	}
	
	p.limits {
		font-size: 1.2em;
		font-style: italic;
		font-weight: bold;
		color: yellow;
		margin-top: -0.5em;
		text-align: center;
	}
	
	p.entry {
		background-color: black;
		line-height: 0.9em;
		padding: 0 8pt 0pt 4pt;
		margin: 12pt 2pt 12pt 40pt;
		position: relative;
		transition: 0.2s background-color, 0.2s color;
		border-top-left-radius: 15pt 100%;
		border-bottom-right-radius: 15pt 100%;
		cursor: pointer;
	}
	
	.index {
		display: inline-block;
		width: 35pt;
		margin: -4pt 0 -4pt -24pt;
		line-height: 32pt;
		text-align: center;
		color: white;
		font-size: 1.3em;
		font-style: italic;
		font-weight: bold;
		background-size: 35pt;
		background-repeat: no-repeat;
		position: relative;
		left: -22pt;
		transition: 0.2s;
	}
	
	.small .index {
		font-size: 1em;
	}
	
	.player {
		max-width: 65%;
		display: inline-block;
		margin-top: 5pt;
	}
	
	.coins {
		display: inline-block;
		font-size: 1.2em;
		font-style: italic;
		font-weight: bold;
		color: yellow;
		float: right;
		line-height: 24pt;
		padding-right: 24pt;
	}
	
	.armscoin {
		position: absolute;
		width: 17pt;
		right: 10pt;
		top: 3pt;
	}
	
	p.entry:hover {
		background-color: yellow;
		color: black !important;
	}
	
	p.entry:hover .coins {
		color: black;
		opacity: 1;
	}
	
	.coin-dark, p.entry:hover .coin-yellow {
		opacity: 0;
	}
	
	p.entry:hover .coin-dark {
		opacity: 1;
	}
	
	p.entry:hover .index {
		transform: scale(1.5);
	}
	
	p.entry.basic .index {
		background-image: url(placement-basic.png);
		color: black;
	}
	
	#sponsor {
		background-color: black;
		border: 2pt solid yellow;
		max-width: 400pt;
		min-height: 40pt;
		position: relative;
		margin: 0 auto;
		padding: 5pt;
	}
	
	#sponsor span {
		display: inline-block;
		width: 80%;
		color: yellow;
		text-align: center;
		font-size: 1.2em;
		display: inline-block;
		margin-right: 20%;
	}
	
	#sponsor img {
		height: 40pt;
		position: absolute;
		right: 5pt; top: 5pt;
	}
	
	.badge-stash {
		width: 100%;
		background-color: #222;
		padding: 10pt;
		box-shadow: 0px 2px 3px #000 inset;
		box-sizing: border-box;
		text-align: center;
		display: none;
		transition: height 0.3s;
		overflow: hidden;
		height: 0;
	}
	
	.badge-container {
		display: inline-block;
		position: relative;
		width: 32pt;
		height: 32pt;
		margin: 3pt;
	}
	
	.badge-image {
		position: absolute;
		top: 0; left: 0;
		width: 100%;
		height: 100%;
		border-radius: 100%;
	}
	
	.badge-overlay {
		position: absolute;
		top: 0; left: 0;
		width: 100%;
		height: 100%;
	}
	
	#badge-feature {
		background-color: #222;
		box-shadow: 0px -2px 3px #000 inset;
		text-align: center;
		margin: 0 auto;
	}
	
	#badge-feature-container {
		width: 200pt;
		height: 200pt;
	}
	
	.change {
		display: none;
		font-weight: bold;
		transition: 0.2s color;
	}
	
	.change-neutral  { color: yellow; }
	.change-positive { color: #0f0; display: inline !important; }
	.change-negative { color: #f00; }
	.change-new, .change-unknown { color: silver; font-style: italic; }
	
	p.entry:hover .change {
		color: black !important;
	}
	
	</style>
	<script>
	var globalShuffle = false;
	
	function badgeDetail(badgeKey, pid)
	{
		var badge = badgeList[badgeKey];
		
		$("badge-feature-title").innerHTML = badge.caption;
		$("badge-feature-image").src = "/assets/badges/" + badgeKey + ".png";
		$("badge-feature-overlay").src = "/assets/badges/overlay-" + badge.style + ".png";
		$("badge-feature-subtext").innerHTML = badge.criterion + ".<br/><a onClick=\"$('player-" + pid + "').scrollIntoView();\">Go back</a>";
		
		$("badge-feature").style.display = "block";
		$("badge-feature").scrollIntoView();
	}
	
	function showBadges(pid, uid)
	{
		var stash = $("badges-" + pid);
		var display = stash.style.display;
		stash.style.display = (display != "block" ? "block" : "none");
		
		user_badges = [];
		
		// Manual badges
		if (badges.hasOwnProperty(uid))
			for (var i = 0; i < badges[uid]["badges"].length; ++i)
				user_badges.push(badges[uid]["badges"][i]);
		
		// Patreon badges
		if (rawPatrons.hasOwnProperty(uid))
		{
			if (rawPatrons[uid].max >= 1) user_badges.push("p0");
			if (rawPatrons[uid].max >= 2) user_badges.push("p1");
			if (rawPatrons[uid].max >= 3) user_badges.push("p2");
		}
		
		// Leaderboard badges
		var games = [
			{ game : "arms", prefix : "" },
			{ game : "kart", prefix : "mk_" }
		];
		
		for (var gi = 0; gi < games.length; ++gi)
			if (rawLeaderboard[games[gi].game].hasOwnProperty(uid))
			{
				for (var i = 1; i < leaderboardTiers[games[gi].game].length-1; ++i)
				{
					if (rawLeaderboard[games[gi].game][uid].coins >= leaderboardTiers[games[gi].game][i].start)
						user_badges.push(games[gi].prefix + "ldb" + (i-1));
				}
			}
		
		if (user_badges.length > 0)
		{
			html = "";
			for (var i = 0; i < user_badges.length; ++i)
			{
				var badgeKey = user_badges[i];
				var badge = badgeList[badgeKey];
				html += "<div class='badge-container' onclick=\"badgeDetail('" + badgeKey + "','" + pid + "');\" title='" + badge.caption + "'>";
				html += "<img class='badge-image' src='/assets/badges/" + badgeKey + ".png'/>";
				html += "<img class='badge-overlay' src='/assets/badges/overlay-" + badge.style + ".png'/>";
				html += "</div>";
			}
			stash.innerHTML = html;
		}
		
		stash.style.height = "auto";
	}
	
	var rawLeaderboard = { arms: null, kart: null };
	var rawSeasonHistory = { arms: null, kart: null };
	var seasonHistory = { arms: null, kart: null };
	var badges = null;
	var rawPatrons = null;
	
	function finalizeLoading()
	{
		if (rawLeaderboard.arms && rawLeaderboard.kart && badges && rawPatrons && seasonHistory.arms)
		{
			switch (window.location.hash.substring(1))
			{
			case "arms":        changeMode(0); break;
			case "monthly":     changeMode(1); break;
			case "kart":        changeMode(2); break;
			case "monthlykart": changeMode(3); break;
			case "patrons":     changeMode(4); break;
			default:            changeMode(0);
			}
		}
	}
	
	function storeLeaderboards(rawBoards)
	{
		rawLeaderboard.arms = rawBoards;
		finalizeLoading();
	}
	
	function storeLeaderboardsMarioKart(rawBoards)
	{
		rawLeaderboard.kart = rawBoards;
		finalizeLoading();
	}
	
	function storeSeasons(rawBoards)
	{
		var games = ["arms", "kart"];
		for (var gi = 0; gi < games.length; ++gi)
		{
			rawSeasonHistory[games[gi]] = [];
			seasonHistory[games[gi]] = [];
			for (var i = 0; i < rawBoards[games[gi]].length; ++i)
			{
				var season = {};
				season.title = monthNames[rawBoards[games[gi]][i].month-1] + " " + rawBoards[games[gi]][i].year;
				season.data = reorganizeLeaderboards(rawBoards[games[gi]][i].leaderboard);
				seasonHistory[games[gi]].push(season);
				
				var copyboard = season.data.slice().sort(function(a, b) { return b.monthly - a.monthly; });
				var rawSeason = {};
				var previous = -1;
				var duplicates = 0;
				
				for (var si = 0; si < copyboard.length && copyboard[si].monthly > 0; ++si)
				{
					duplicates = (copyboard[si].monthly == previous) ? duplicates + 1 : 0;
					previous = copyboard[si].monthly;
					rawSeason[copyboard[si].id] = si + 1 - duplicates;
				}
				rawSeasonHistory[games[gi]].push(rawSeason);
			}
		}
		finalizeLoading();
	}
	
	function storePatrons(getPatrons)
	{
		rawPatrons = getPatrons;
		finalizeLoading();
	}
	
	function storeBadges(getBadges)
	{
		badges = getBadges;
		finalizeLoading();
	}
	
	function displayRolePlayers(players, tc, mode, showIndex)
	{
		var tier = leaderboardTiers[mode][tc];
		if (globalShuffle) shuffle(players);
		
		var html = "<div class='tier tier-" + getTierID(tier) + "'>";
		var previous = -1;
		var duplicates = 0;
		for (var pi = 0; pi < players.length; pi++)
		{
			duplicates = (players[pi].coins == previous) ? duplicates + 1 : 0;
			previous = players[pi].coins;
			var useIndex = pi + 1 - duplicates;
			
			var pid = "leaderboard-" + tc + "-" + pi;
			html += "<p onclick=\"showBadges('" + pid + "','" + players[pi].id + "');\" id='player-" + pid + "' class='entry " + ((useIndex > 99) ? " small" : "") + "' style='color: " + tier.color + ";'><span class='index'><span class='index-number'>" + (showIndex ? useIndex : "&nbsp;") + "</span></span>";
			html += "<span class='player'>" + players[pi].name + "</span>";
			html += "<span class='coins'>" + players[pi].coins + "<img class='armscoin coin-yellow' src='coin_" + mode +".png'/><img class='armscoin coin-dark' src='coin_" + mode +"_dark.png'/></span></p>";
			html += "<div class='badge-stash' id='badges-" + pid + "'>A Discord connection is required for badge collection!</div>";
		}
		return html + "</div>";
	}
	
	function displayRoleMeta(tc, mode)
	{
		var tierID = getTierID(leaderboardTiers[mode][tc]);
		var tier = leaderboardTiers[mode][tc];
		var title = (mode == "arms") ? "ARMS Labs " + tier.name : tier.name + " Cup Racer";
		
		var html = "<h3 id='tier-" + getTierID(tier) + "' style='color: " + tier.color + ";'>" + title + "</h3>";
		html += "<p class='limits'>" + tier.start + " <img class='armscoin-text' src='coin_" + mode +".png'/>";
		if (tc == leaderboardTiers[mode].length-2)
			html += " +";
		else if (tc != 0)
			html += " &#8211; " + (leaderboardTiers[mode][tc+1].start-1) + " <img class='armscoin-text' src='coin_" + mode +".png'/></p>";
		
		var menu_html = "<a class='menu-item m5 tier-" + tierID + "' href='#tier-" + tierID + "' style='color: " + tier.color + ";'>" + title + "</a>";
		
		var css  = ".tier-" + tierID + " p.entry:hover, a.menu-item.tier-" + tierID + ":hover ";
		css += "{ background-color: " + tier.color + " !important; color: black !important; }";
		css += ".tier-" + tierID + " .index " + "{ background-image: url(placement-" + tierID + ".png); color: black; }";
		
		return {css: css, menu: menu_html, body: html};
	}
	
	function displayLeaderboards(mode)
	{
		var leaderboard = reorganizeLeaderboards(rawLeaderboard[mode]);
		
		var menu_html = "<div class='menu-container'>";
		var body_html = "<div>";
		var css = "";
		
		var scrolltoid = null;
		var useTiers = leaderboardTiers[mode];
		var tc = useTiers.length-2;
		
		var players = [];
		var ldbPLayers = {};
		
		var first = true;
		
		for (var i = 0; i < leaderboard.length && leaderboard[i].coins > 0; ++i)
		{
			while (leaderboard[i].coins < useTiers[tc].start)
			{
				if (players.length > 0 || !first)
				{
					var result = displayRoleMeta(tc, mode);
					body_html += result.body;
					menu_html += result.menu;
					css += result.css;
					first = false;
				}
				
				body_html += displayRolePlayers(players, tc, mode, true);
				
				if (window.location.hash.substring(1) == getTierID(useTiers[tc]))
					scrolltoid = getTierID(useTiers[tc]);
				
				tc--;
				players = [];
			}
			
			ldbPLayers[leaderboard[i].id] = 1;
			players.push(leaderboard[i]);
		}
		
		var result = displayRoleMeta(tc, mode);
		menu_html += result.menu;
		css += result.css;
		body_html += result.body + displayRolePlayers(players, tc, mode, true);
		
		if (mode == "arms")
		{
			// Players not in leaderboard but still with badges
			var result = displayRoleMeta(0, mode);
			menu_html += result.menu;
			css += result.css;
			
			if (window.location.hash.substring(1) == "testsubject")
				scrolltoid = tierName;
			
			var zeroes = [];
			for (var key in badges)
				if (!ldbPLayers.hasOwnProperty(key))
					zeroes.push({name: badges[key].name, coins: 0, monthly: 0, id: key});
			
			body_html += result.body + displayRolePlayers(zeroes, 0, mode, false);
		}
		
		$("leaderboard").innerHTML = menu_html + "</div>" + body_html + "</div>";
		var style = document.createElement('style');
		style.appendChild(document.createTextNode(css));
		document.getElementsByTagName('head')[0].appendChild(style);
	}
	
	function displayMonthly(useBoard, prevRawBoard)
	{
		var copyboard = useBoard.slice().filter(function (item) { return item.monthly > 0; }).sort(function(a, b) { return b.monthly - a.monthly; });
		if (globalShuffle) shuffle(copyboard);
		var previous = -1;
		var duplicates = 0;
		var html = "<div class='tier'>";
		
		for (var i = 0; i < copyboard.length && copyboard[i].monthly > 0; ++i)
		{
			duplicates = (copyboard[i].monthly == previous) ? duplicates + 1 : 0;
			previous = copyboard[i].monthly;
			var useIndex = i + 1 - duplicates;
			var changetext = "<span class='change change-unknown'>" + ((prevRawBoard != null) ? "???" : "new") + "</span>";
			
			if (prevRawBoard != null && copyboard[i].id != null)
			{
				var change = prevRawBoard.hasOwnProperty(copyboard[i].id) ? (prevRawBoard[copyboard[i].id] - useIndex) : undefined;
				if (change == 0)
					changetext = "<span class='change change-neutral'>&nbsp;&nbsp;➡︎"  + "</span>";
				else if (change > 0)
					changetext = "<span class='change change-positive'>⬆︎" +   change  + "</span>";
				else if (change < 0)
					changetext = "<span class='change change-negative'>⬇︎" + (-change) + "</span>";
				else
					changetext = "<span class='change change-new'>new</span>";
			}
		
			var pid = "monthly-" + i;
			html += "<p onclick=\"showBadges('" + pid + "','" + copyboard[i].id + "');\" id='player-" + pid + "' class='entry basic" + ((useIndex > 99) ? " small" : "") + "' style='color: white;'><span class='index'><span class='index-number'>" + useIndex + "</span></span>";
			html += "<span class='player'>" + copyboard[i].name + "</span> " + changetext;
			html += "<span class='coins'>" + copyboard[i].monthly + "<img class='armscoin coin-yellow' src='coin_arms.png'/><img class='armscoin coin-dark' src='coin_arms_dark.png'/></span></p>";
			html += "<div class='badge-stash' id='badges-" + pid + "'>A Discord connection is required for badge collection!</div>";
		}
		
		$("leaderboard").innerHTML = html + "</div>";
	}
	
	function displayPatreon()
	{
		var html = "<p style='text-align: center;'>Contribute to Casual ARMS on <a href='https://www.patreon.com/CasualARMS'><em style='background-color: #f36b61;''>Patreon</em></a>!</p>";
		var css = "";
		var tc = patreonTiers.length;
		var index = 1;
		
		// Reformat database
		var patrons = [];
		for (var key in rawPatrons)
		{
			if (rawPatrons.hasOwnProperty(key) && key != "UNKNOWN")
			{
				var user = rawPatrons[key];
				patrons.push([user.name, user.tier, key]);
			}
		}
		for (var i = 0; i < rawPatrons.UNKNOWN.length; ++i)
			patrons.push([rawPatrons.UNKNOWN[i].name, rawPatrons.UNKNOWN[i].tier, null]);
		
		patrons.sort(function(a, b) { return b[1] - a[1]; });
		
		for (var i = 0; i < patrons.length; ++i)
		{
			if (tc != (patrons[i][1]-1))
			{
				if (tc == 0) break;
				
				tc = patrons[i][1]-1;
				var tierName = patreonTiers[tc].name;
				var tierID = "p" + tc;
				html += "</div><h3 id='tier-" + tierID + "' style='color: " + patreonTiers[tc].color + ";'>" + tierName + "</h3><div class='tier tier-" + tierID + "'>";
				html += "<p class='limits' style='color: #f36b61;''>$" + patreonTiers[tc].start + " or more per month</p>";
				
				// Generate CSS
				css += ".tier-" + tierID + " p.entry:hover, a.menu-item.tier-" + tierID + ":hover ";
				css += "{ background-color: " + patreonTiers[tc].color + " !important; color: black !important; }";
				css += ".tier-" + tierID + " p.entry .index { background-image: url(placement-" + tierID + ".png); color: black; }";
			}
			
			var pid = "patron-" + (index++);
			html += "<p onclick=\"showBadges('" + pid + "','" + patrons[i][2] + "');\" id='player-" + pid + "' class='entry basic" + ((index > 99) ? " small" : "") + "' style='color: " + patreonTiers[tc].color + ";'><span class='index'>&nbsp;</span>";
			html += "<span class='player'>" + patrons[i][0] + "</span>";
			html += "<div class='badge-stash' id='badges-" + pid + "'>A Discord connection is required for badge collection!</div>";
		}
		
		html += "</div>";
		$("leaderboard").innerHTML = html;
		
		// Add CSS
		var style = document.createElement('style');
		style.appendChild(document.createTextNode(css));
		document.getElementsByTagName('head')[0].appendChild(style);
	}
	
	var activeGame;
	
	function changeMode(mode)
	{
		$("md0").className = $("md1").className = $("md2").className = $("md3").className = $("md4").className = "mode";
		$("md" + mode).className += " active-mode";
		$("season").selectedIndex = 0;
		$("season-nav").style.display = (mode == 1 || mode == 3) ? "block" : "none";
		
		document.getElementsByTagName("H1")[0].className = (mode == 2 || mode == 3) ? "kart" : "";
		document.getElementsByTagName("H1")[0].children[0].innerHTML = (mode == 2 || mode == 3) ? "Casual Kart" : "Casual ARMS";
		
		activeGame = (mode == 2 || mode == 3) ? "kart" : "arms";
		
		var today = new Date();
		var options = "<option value='0'>" + monthNames[today.getMonth()] + " " + today.getFullYear() + " (Current)</option>";
		
		for (var i = 0; i < seasonHistory[activeGame].length; ++i)
			options += "<option value='" + (i+1) +"'>" + seasonHistory[activeGame][i].title + "</option>";
		$("season").innerHTML = options;
		
		switch (mode)
		{
		case 0: displayLeaderboards("arms"); break;
		case 1: selectSeason("arms"); break;
		case 2: displayLeaderboards("kart"); break;
		case 3: selectSeason("kart"); break;
		case 4: displayPatreon(); break;
		}
	}
	
	function selectSeason(game)
	{
		var activeSeasonIndex = $("season").selectedIndex;
		
		var useBoard = reorganizeLeaderboards(rawLeaderboard[game]);
		if (activeSeasonIndex > 0)
			useBoard = seasonHistory[game][activeSeasonIndex-1].data;
		
		var prevRawBoard = (activeSeasonIndex < rawSeasonHistory[game].length) ? rawSeasonHistory[game][activeSeasonIndex] : null;
		
		displayMonthly(useBoard, prevRawBoard);
	}
	
	function load()
	{
		fetchLeaderboards("arms", storeLeaderboards);
		fetchLeaderboards("kart", storeLeaderboardsMarioKart);
		fetchSeasonHistory(storeSeasons);
		fetchPatrons(storePatrons);
		fetchBadges(storeBadges);
	}
	</script>
</head>

<body onload="load()">
	<h1><a href="/">Casual ARMS</a></h1>
	<div id="container" class="container-dark">
		
		<h2>Leaderboards</h2>
		
		<p>Casual ARMS are officially tracking your <img class='armscoin-text' src='coin_arms.png'/> coins throughout every major <a href="/lobbies/"><em>lobby event</em></a> we hold! At the moment, this means the <a href="/lobbies/#tuesday">Tuesday</a>, <a href="/lobbies/#wednesday">Wednesday</a>, <a href="/lobbies/#thursday">Thursday</a>, and <a href="/lobbies/#saturday">Saturday</a> lobbies. As every 20 coin lobby <em>finishes</em>, a screenshot of the <img class='armscoin-text' src='coin_arms.png'/> coins acquired will be logged and the totals recorded. Those coins will add to your totals for the server leaderboard, displayed here! (New roles will be revealed as they are acquired.)</p>
		
		<h3>Badges</h3>
		
		<p>Members of the Casual ARMS <a href="https://discord.gg/5A7QkPC"><em class="discord-bg">Discord server</em></a> can now collect badges from different activities! Badges are awarded for leaderboard progression and <a href='https://www.patreon.com/CasualARMS'><em style="background-color: #f36b61;">Patreon</em></a> support, among other things, and new badges will be unveiled regularly! Click on an entry in the leaderboard listings to view their badge stash.</p>
		
		<div id="badge-feature" style="display: none;">
			<h3 id="badge-feature-title"></h3>
			<div id="badge-feature-container" class="badge-container">
				<img id="badge-feature-image" class="badge-image">
				<img id="badge-feature-overlay" class="badge-overlay">
			</div>
			<p id="badge-feature-subtext"></p>
		</div>
		
		<p id="mode-selector">
			<span class="split-mode">
				<em class="mode active-mode" id="md0" onClick="changeMode(0);">ARMS</em><em class="mode" id="md1" onClick="changeMode(1);">Monthly</em>
			</span>
			<span class="split-mode">
				<em class="mode" id="md2" onClick="changeMode(2);">Kart</em><em class="mode" id="md3" onClick="changeMode(3);">Monthly</em>
			</span>
			<em class="mode" id="md4" onClick="changeMode(4);">Patrons</em>
		</p>
		
		<p id="season-nav">
			<select id="season" onChange="selectSeason(activeGame)">
			</select>
		</p>
		
		<div id="leaderboard"></div>
	</div>
</body>
</html>
